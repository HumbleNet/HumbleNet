namespace humblenet.HumblePeer;

// Component tables
table Attribute {
	key:string (required, key);
	value:string (required);
}

enum ICEServerType : uint8 { STUNServer = 1, TURNServer = 2}

table ICEServer {
	type			: ICEServerType = STUNServer;
	server			:string (required);
	username		:string;
	password		:string;
}

// Message tables

// Hello
table HelloServer {
	version			: uint32;
	flags			: uint8;
	game_token		: string (required);
	game_signature	: string (required);
	auth_token		: string;
	reconnect_token	: string;
	attributes		: [Attribute];
}

table HelloClient {
	peer_id			: uint32;
	reconnectToken	: string;
	ice_servers		: [ICEServer];
}

// P2P Handshaking

table P2POffer {
	peer_id			: uint32;
	flags			: uint8;
	offer			: string;
}

table P2PAnswer {
	peer_id			: uint32;
	offer			: string;
}

table P2PConnected {
	peer_id			: uint32;
}

table P2PDisconnect {
	peer_id			: uint32;
}

enum P2PRejectReason : uint8 { NotFound = 1, PeerRefused = 2 }

table P2PReject {
	peer_id			: uint32;
	reason			: P2PRejectReason = NotFound;
}

table ICECandidate {
	peer_id			: uint32;
	offer			: string;
}

table P2PRelayData {
	peer_id			: uint32;
	data			: [byte];
}

// Generic messages
table Success {
}

table Error {
	error			: string;
}

// Name alias handling

table AliasRegister {
	alias			: string (required);
}

table AliasUnregister {
	alias			: string;
}

table AliasLookup {
	alias			: string (required);
}

table AliasResolved {
	alias			: string (required);
	peer_id			: uint32;
}

// Message switch
union MessageType {
	// Main peer-server connection (1 -> 9)
	HelloServer, HelloClient,
	// P2P Negotiation specific messages (10 -> 19)
	P2PConnected = 10, P2PDisconnect, P2POffer, P2PAnswer, P2PReject, ICECandidate, P2PRelayData,
	// Name Alias system (20 -> 29)
	AliasRegister = 20, AliasUnregister,
	AliasLookup, AliasResolved,
	AliasRegisterError:Error, AliasRegisterSuccess:Success,
	AliasUnregisterError:Error, AliasUnregisterSuccess:Success,
}

table Message {
	message			: MessageType;
	request_id		: uint32;
}

root_type Message;